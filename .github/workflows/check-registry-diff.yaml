name: Check Semantic Convention Registry Diff

on:
  pull_request:
    paths:
      - 'pkg/inst-api-semconv/**'
  push:
    branches:
      - main
    paths:
      - 'pkg/inst-api-semconv/**'

permissions:
  contents: read
  pull-requests: write

env:
  # OTel Weaver version to use for registry diff check
  WEAVER_VERSION: v0.19.0
  # Semantic conventions registry URL
  SEMCONV_REGISTRY: https://github.com/open-telemetry/semantic-conventions.git

jobs:
  registry-diff:
    name: Check Registry Diff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          fetch-depth: 0  # Fetch full history for baseline comparison

      - name: Install OTel Weaver
        run: |
          # Download and install weaver binary
          WEAVER_ARCH="x86_64-unknown-linux-gnu"
          WEAVER_URL="https://github.com/open-telemetry/weaver/releases/download/${WEAVER_VERSION}/weaver-${WEAVER_ARCH}.tar.xz"

          curl -fsSL "${WEAVER_URL}" -o weaver.tar.xz
          tar -xJf weaver.tar.xz
          chmod +x weaver
          sudo mv weaver /usr/local/bin/weaver
          rm -f weaver.tar.xz

          # Verify installation
          weaver --version

      - name: Validate semantic conventions registry
        if: github.event_name == 'pull_request'
        run: |
          # First, validate the registry to catch any schema errors
          echo "::group::Validating semantic convention registry"
          weaver registry check \
            --registry "${SEMCONV_REGISTRY}[model]" \
            --diagnostic-format gh_workflow_command \
            --future
          echo "::endgroup::"

      - name: Generate registry diff against main branch
        if: github.event_name == 'pull_request'
        run: |
          # Create output directory
          mkdir -p registry-diff-output

          # Run registry diff comparing current PR branch against main branch
          # Using the semantic conventions registry as baseline
          echo "::group::Generating registry diff"
          weaver registry diff \
            --registry "${SEMCONV_REGISTRY}[model]" \
            --baseline-registry "${SEMCONV_REGISTRY}[model]" \
            --diff-format markdown \
            --output registry-diff-output/diff.md \
            --diagnostic-format gh_workflow_command \
            --future
          echo "::endgroup::"

          echo "Registry diff completed. Check output below:"
          if [ -f registry-diff-output/diff.md ]; then
            cat registry-diff-output/diff.md
          fi

      - name: Check registry diff for main branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Create output directory
          mkdir -p registry-diff-output

          # For main branch, just validate the current state
          weaver registry check \
            --registry "${SEMCONV_REGISTRY}[model]" \
            --diagnostic-format gh_workflow_command \
            --future

          echo "Registry validation completed for main branch"

      - name: Upload diff report
        if: github.event_name == 'pull_request' && always()
        uses: actions/upload-artifact@ea165f8d65b6bb5d4667c85d1fc677ab6a7f3c13  # v4.6.2
        with:
          name: registry-diff-report
          path: registry-diff-output/
          retention-days: 30

      - name: Comment PR with diff summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const diffFile = 'registry-diff-output/diff.md';

            let comment = '## ðŸ“Š Semantic Convention Registry Diff Report\n\n';

            if (fs.existsSync(diffFile)) {
              const diffContent = fs.readFileSync(diffFile, 'utf8');
              comment += diffContent;
            } else {
              comment += 'âœ… No registry differences detected or diff report generation failed.\n';
              comment += '\nPlease check the workflow logs for more details.';
            }

            comment += '\n\n---\n';
            comment += '*This report was generated by the [OTel Weaver](https://github.com/open-telemetry/weaver) registry diff tool.*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Semantic Convention Registry Diff Report')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
